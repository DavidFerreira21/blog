{{ define "main" }}
{{- $sections := slice "posts" "labs" -}}
{{- $pages := where site.RegularPages "Type" "in" $sections -}}
{{- $pages = $pages.ByDate.Reverse -}}

<section class="home-hero">
    <div class="hero-inner">
        <div class="hero-copy">
            <p class="hero-kicker">Posts</p>
            <h1 class="hero-title">{{ .Title }}</h1>
            {{- with .Params.description }}
            <p class="hero-subtitle">{{ . }}</p>
            {{- end }}
        </div>
    </div>
</section>

<section class="home-feed">
    {{- with site.Taxonomies.categories }}
    <div class="category-select" data-filter="posts">
        <details class="category-dropdown">
            <summary>All categories</summary>
            <div class="category-options">
                <button class="category-option is-active" type="button" data-filter="all">All categories</button>
                {{- range $name, $taxonomy := . }}
                <button class="category-option" type="button" data-filter="{{ $name | urlize }}">{{ $name }}</button>
                {{- end }}
            </div>
        </details>
    </div>
    {{- end }}

    <div class="feed-grid">
        {{- range $pages }}
        <article class="home-card has-media" data-categories="{{ with .Params.categories }}{{ delimit (apply . "urlize" ".") " " }}{{ end }}">
            <a class="card-link" href="{{ .RelPermalink }}">
                {{- $cover := "" -}}
                {{- with .Params.cover }}
                {{- $cover = .image | default "" -}}
                {{- end -}}
                {{- if not $cover }}
                {{- with .Params.image }}
                {{- $cover = . -}}
                {{- end -}}
                {{- end -}}
                {{- if $cover }}
                <div class="card-media">
                    <img src="{{ $cover | relURL }}" alt="{{ with .Params.cover }}{{ .alt | default $.Title }}{{ else }}{{ .Title }}{{ end }}">
                </div>
                {{- end }}
                <div class="card-meta">
                    <span class="card-section">
                        {{- with .CurrentSection }}{{ .Title }}{{- else }}{{ .Section | title }}{{- end }}
                    </span>
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "02 Jan 2006" }}</time>
                </div>
                <h3 class="card-title">{{ .Title }}</h3>
                {{- with .Summary }}
                <p class="card-summary">{{ . | plainify | truncate 160 }}</p>
                {{- end }}
                {{- with .Params.tags }}
                <div class="card-tags">
                    {{- range first 3 . }}
                    <span class="tag">#{{ . }}</span>
                    {{- end }}
                </div>
                {{- end }}
            </a>
        </article>
        {{- end }}
    </div>
</section>

<script>
(() => {
    const dropdown = document.querySelector(".category-dropdown");
    if (!dropdown) return;

    const summary = dropdown.querySelector("summary");
    const buttons = dropdown.querySelectorAll("[data-filter]");
    const cards = document.querySelectorAll(".home-card");

    const applyFilter = (value) => {
        const label = value === "all" ? "All categories" : value.replace(/-/g, " ");
        summary.textContent = label;
        buttons.forEach((btn) => btn.classList.toggle("is-active", btn.dataset.filter === value));
        cards.forEach((card) => {
            const categories = (card.dataset.categories || "").split(" ").filter(Boolean);
            const visible = value === "all" || categories.includes(value);
            card.style.display = visible ? "" : "none";
        });
        dropdown.open = false;
    };

    buttons.forEach((btn) => {
        btn.addEventListener("click", () => applyFilter(btn.dataset.filter));
    });

    const params = new URLSearchParams(window.location.search);
    const initial = params.get("cat");
    if (initial) {
        const match = Array.from(buttons).find((btn) => btn.dataset.filter === initial);
        if (match) applyFilter(initial);
    }
})();
</script>
{{ end }}
